<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Ice Timer Sparkle Editor</title>
  <style>
    :root{
      color-scheme: dark;
    }
    body{
      margin:0;
      padding:20px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#050615;
      color:#f5f5ff;
    }
    h1{
      margin:0 0 10px 0;
      font-size:1.4rem;
    }
    .layout{
      display:flex;
      gap:24px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .panel{
      background:#111325;
      border-radius:16px;
      padding:14px 16px;
      box-shadow:0 0 24px #000000c5;
    }
    .controls{
      width:360px;
      max-width:100%;
    }
    .controls h2,
    .preview-wrap h2,
    .output-wrap h2{
      font-size:1rem;
      margin:0 0 8px 0;
      color:#c7c7ff;
    }
    .control-group{
      margin-bottom:10px;
    }
    .control-group label{
      display:block;
      font-size:0.82rem;
      margin-bottom:4px;
    }
    .control-inline{
      display:flex;
      gap:8px;
    }
    .control-inline .control-group{
      flex:1;
      margin-bottom:0;
    }
    input[type="number"],
    input[type="text"],
    input[type="url"],
    select{
      width:100%;
      box-sizing:border-box;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #40436a;
      background:#070716;
      color:#f5f5ff;
      font-size:0.85rem;
    }
    input[type="color"]{
      width:100%;
      height:32px;
      padding:0;
      border-radius:6px;
      border:1px solid #40436a;
      background:#070716;
      box-sizing:border-box;
    }
    input[type="range"]{
      width:100%;
    }
    .checkbox-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.85rem;
    }
    button{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      margin-top:6px;
      background:#4af2c5;
      color:#050f12;
      box-shadow:0 0 18px #4af2c57a;
    }
    button:hover{
      filter:brightness(1.05);
    }

    .preview-wrap{
      flex:0 0 320px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .preview-box{
      width:320px;
      height:320px;
      background:#050616;
      border-radius:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      box-shadow:0 0 24px #000000d9;
    }

    .output-wrap{
      flex:1 1 360px;
      min-width:280px;
    }
    textarea{
      width:100%;
      min-height:380px;
      box-sizing:border-box;
      padding:10px;
      border-radius:10px;
      border:1px solid #40436a;
      background:#050616;
      color:#f5f5ff;
      font-family:"JetBrains Mono","Fira Code",monospace;
      font-size:0.8rem;
      resize:vertical;
    }
    .hint{
      font-size:0.8rem;
      color:#a4a4ff;
      margin-top:4px;
    }

    /* ===== ПРЕВЬЮ ТАЙМЕРА ===== */

    .preview-timer-container{
      position:relative;
      width:92%;
      height:92%;
      background-size:contain;
      background-position:center;
      background-repeat:no-repeat;
      pointer-events:none;
    }

    #preview-sparkles{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      border-radius:50%;
      clip-path:circle(50% at 50% 50%);
      pointer-events:none;
      z-index:2;
    }

    .preview-time{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%, -50%);
      font-family:'Emilys Candy',cursive;
      font-size:2.6em;
      color:#ffffff;
      text-shadow:0 0 8px #7fd7ff,0 0 16px #7fd7ff;
      user-select:none;
      z-index:3;
      white-space:nowrap;
    }
  </style>

  <link id="preview-font-link" rel="stylesheet" />
</head>
<body>
  <h1>Ice Timer Sparkle Editor</h1>
  <p class="hint">
    Центр круга блёсток = центр цифр. В редакторе настраиваешь фон, шрифт, цвет, радиус круга, смещение по X/Y.
    Справа получаешь готовый HTML для iframe / Genially.
  </p>

  <div class="layout">
    <!-- ===== ПАНЕЛЬ УПРАВЛЕНИЯ ===== -->
    <div class="panel controls">
      <h2>Настройки</h2>

      <div class="control-group">
        <label for="bgUrl">Фоновая картинка таймера (URL)</label>
        <input type="url" id="bgUrl"
               value="https://i.postimg.cc/28yZbpGP/Chat-GPT-Image-19-noab-2025-g-21-37-10.png">
      </div>

      <div class="control-inline">
        <div class="control-group">
          <label for="totalSeconds">Время (сек.)</label>
          <input type="number" id="totalSeconds" min="1" value="30">
        </div>
        <div class="control-group">
          <label for="sparkleRadius">Радиус круга блёсток (×размер цифр)</label>
          <input type="range" id="sparkleRadius" min="1.0" max="3.0" step="0.1" value="1.8">
        </div>
      </div>

      <div class="control-group">
        <label for="fontName">Шрифт Google Fonts (название)</label>
        <input type="text" id="fontName" value="Emilys Candy">
      </div>

      <div class="control-inline">
        <div class="control-group">
          <label for="fontSize">Размер цифр (em)</label>
          <input type="number" id="fontSize" step="0.1" min="1" value="2.8">
        </div>
        <div class="control-group">
          <label for="sparkleCount">Плотность блёсток</label>
          <input type="range" id="sparkleCount" min="40" max="260" step="10" value="160">
        </div>
      </div>

      <div class="control-inline">
        <div class="control-group">
          <label for="offsetX">Смещение центра (X, px)</label>
          <input type="range" id="offsetX" min="-100" max="100" value="0">
        </div>
        <div class="control-group">
          <label for="offsetY">Смещение центра (Y, px)</label>
          <input type="range" id="offsetY" min="-100" max="100" value="0">
        </div>
      </div>

      <div class="control-inline">
        <div class="control-group">
          <label for="textColor">Цвет цифр</label>
          <input type="color" id="textColor" value="#ffffff">
        </div>
        <div class="control-group">
          <label for="sparkleColor">Цвет блёсток</label>
          <input type="color" id="sparkleColor" value="#7fd7ff">
        </div>
      </div>

      <div class="control-group checkbox-row">
        <input type="checkbox" id="glowEnabled" checked>
        <label for="glowEnabled">Свечение цифр и блёсток</label>
      </div>

      <button id="generateBtn">Сгенерировать HTML-код</button>
    </div>

    <!-- ===== ПРЕВЬЮ ===== -->
    <div class="preview-wrap">
      <h2>Preview</h2>
      <div class="panel preview-box">
        <div id="preview-timer" class="preview-timer-container">
          <canvas id="preview-sparkles"></canvas>
          <div id="preview-time" class="preview-time">0:30</div>
        </div>
      </div>
      <p class="hint">
        Двигай X/Y — цифры и блёстки двигаются вместе. Радиус меняет размер кольца. Цвет блёсток и шрифт видны сразу.
      </p>
    </div>

    <!-- ===== ВЫХОДНОЙ КОД ===== -->
    <div class="panel output-wrap">
      <h2>Готовый HTML</h2>
      <textarea id="output" spellcheck="false"></textarea>
      <p class="hint">
        Скопируй содержимое в iframe / расширение Genially. Таймер центрируется в iframe, масштабируется вместе
        с ним, прогресс показывает кольцо из блёсток вокруг цифр.
      </p>
    </div>
  </div>

  <script>
    const bgUrlInput        = document.getElementById('bgUrl');
    const totalSecondsInput = document.getElementById('totalSeconds');
    const sparkleRadiusInput= document.getElementById('sparkleRadius');
    const fontNameInput     = document.getElementById('fontName');
    const fontSizeInput     = document.getElementById('fontSize');
    const sparkleCountInput = document.getElementById('sparkleCount');
    const offsetXInput      = document.getElementById('offsetX');
    const offsetYInput      = document.getElementById('offsetY');
    const textColorInput    = document.getElementById('textColor');
    const sparkleColorInput = document.getElementById('sparkleColor');
    const glowEnabledInput  = document.getElementById('glowEnabled');

    const previewTimer   = document.getElementById('preview-timer');
    const previewCanvas  = document.getElementById('preview-sparkles');
    const previewCtx     = previewCanvas.getContext('2d');
    const previewTimeEl  = document.getElementById('preview-time');
    const fontLink       = document.getElementById('preview-font-link');
    const outputTextarea = document.getElementById('output');
    const generateBtn    = document.getElementById('generateBtn');

    let previewTotalSeconds = 30;
    let previewRemaining    = 30;
    let previewTimerInterval= null;
    let lastFrameTime       = 0;

    function updatePreviewFont(fontName){
      const fontParam = (fontName || 'Emilys Candy').trim().replace(/\s+/g,'+');
      fontLink.href = `https://fonts.googleapis.com/css2?family=${fontParam}&display=swap`;
    }

    function resizePreviewCanvas(){
      const rect = previewCanvas.getBoundingClientRect();
      const dpr  = window.devicePixelRatio || 1;
      previewCanvas.width  = rect.width * dpr;
      previewCanvas.height = rect.height * dpr;
      previewCtx.setTransform(dpr,0,0,dpr,0,0);
    }

    function getPreviewCircleMetrics(){
      const canvasRect = previewCanvas.getBoundingClientRect();
      const textRect   = previewTimeEl.getBoundingClientRect();
      const cx = (textRect.left + textRect.width/2) - canvasRect.left;
      const cy = (textRect.top  + textRect.height/2) - canvasRect.top;
      const base = Math.max(textRect.width, textRect.height);
      const radiusMult = parseFloat(sparkleRadiusInput.value) || 1.8;
      const r = base * radiusMult;
      return {cx,cy,r};
    }

    function updatePreviewStyles(){
      const bgUrl        = bgUrlInput.value.trim();
      const fontName     = fontNameInput.value.trim() || 'Emilys Candy';
      const fontSize     = parseFloat(fontSizeInput.value) || 2.8;
      const offsetX      = parseInt(offsetXInput.value,10) || 0;
      const offsetY      = parseInt(offsetYInput.value,10) || 0;
      const textColor    = textColorInput.value || '#ffffff';
      const sparkleColor = sparkleColorInput.value || '#7fd7ff';
      const glowEnabled  = glowEnabledInput.checked;

      previewTimer.style.backgroundImage = bgUrl ? `url("${bgUrl}")` : 'none';

      previewTimeEl.style.fontFamily = `'${fontName}', cursive`;
      previewTimeEl.style.fontSize   = fontSize+'em';
      previewTimeEl.style.color      = textColor;
      previewTimeEl.style.left = '50%';
      previewTimeEl.style.top  = '50%';
      previewTimeEl.style.transform =
        `translate(calc(-50% + ${offsetX}px), calc(-50% + ${offsetY}px))`;

      if (glowEnabled){
        previewTimeEl.style.textShadow =
          `0 0 8px ${sparkleColor},0 0 18px ${sparkleColor}`;
      } else {
        previewTimeEl.style.textShadow = 'none';
      }
      updatePreviewFont(fontName);
      resizePreviewCanvas();
    }

    function formatTime(sec){
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${m}:${s<10?'0
