<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Ice Timer Sparkle Editor</title>
  <style>
    :root{
      color-scheme: dark;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      padding:20px;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#050712;
      color:#f5f5ff;
    }
    h1{
      margin:0 0 4px 0;
      font-size:1.4rem;
    }
    .subtitle{
      font-size:0.82rem;
      color:#a9a9ff;
      margin-bottom:16px;
    }
    .layout{
      display:flex;
      gap:20px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .panel{
      background:#0c0f20;
      border-radius:14px;
      padding:14px 16px;
      box-shadow:0 0 24px rgba(0,0,0,0.6);
    }
    .controls{
      width:340px;
      max-width:100%;
    }
    .controls h2,
    .preview-wrap h2,
    .output-wrap h2{
      font-size:1rem;
      margin:0 0 8px 0;
      color:#d0d0ff;
    }
    .control-group{
      margin-bottom:10px;
    }
    .control-group label{
      display:block;
      font-size:0.82rem;
      margin-bottom:4px;
    }
    .control-inline{
      display:flex;
      gap:8px;
    }
    .control-inline .control-group{
      flex:1;
      margin-bottom:0;
    }
    input[type="number"],
    input[type="text"],
    input[type="url"],
    select{
      width:100%;
      padding:6px 8px;
      border-radius:6px;
      border:1px solid #353863;
      background:#050712;
      color:#f5f5ff;
      font-size:0.85rem;
    }
    input[type="color"]{
      width:100%;
      height:32px;
      padding:0;
      border-radius:6px;
      border:1px solid #353863;
      background:#050712;
    }
    input[type="range"]{
      width:100%;
    }
    .checkbox-row{
      display:flex;
      align-items:center;
      gap:6px;
      font-size:0.85rem;
      margin-top:4px;
    }
    button{
      width:100%;
      padding:8px 10px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      font-weight:600;
      margin-top:8px;
      background:#4af2c5;
      color:#050712;
      box-shadow:0 0 18px rgba(74,242,197,0.45);
    }
    button:hover{ filter:brightness(1.05); }

    .preview-wrap{
      flex:0 0 320px;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .preview-box{
      width:320px;
      height:320px;
      background:#050712;
      border-radius:18px;
      display:flex;
      align-items:center;
      justify-content:center;
      position:relative;
      overflow:hidden;
      box-shadow:0 0 24px rgba(0,0,0,0.85);
    }

    .output-wrap{
      flex:1 1 380px;
      min-width:280px;
    }
    textarea{
      width:100%;
      min-height:380px;
      padding:10px;
      border-radius:10px;
      border:1px solid #353863;
      background:#050712;
      color:#f5f5ff;
      font-family:"JetBrains Mono","Fira Code",monospace;
      font-size:0.8rem;
      resize:vertical;
    }
    .hint{
      font-size:0.8rem;
      color:#a4a4ff;
      margin-top:4px;
    }

    /* ===== ПРЕВЬЮ ТАЙМЕРА ===== */
    .timer-preview-root{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .timer-preview-outer{
      position:relative;
      width:90%;
      height:90%;
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
    }
    .timer-preview-inner{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #preview-canvas{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .timer-preview-time{
      position:absolute;
      transform:translate(-50%,-50%);
      font-family:'Emilys Candy',cursive;
      font-size:2.8em;
      color:#e9f8ff;
      text-shadow:0 0 8px #7fd7ff,0 0 16px #7fd7ff;
      user-select:none;
      z-index:2;
      left:50%;
      top:50%;
    }
  </style>
  <link id="preview-font-link" rel="stylesheet" />
</head>
<body>
  <h1>Ice Timer Sparkle Editor</h1>
  <p class="subtitle">
    Центр круга = центр цифр. Радиус задаётся в процентах от кадра (не зависит от текста).
    Справа — готовый HTML для iframe / Genially.
  </p>

  <div class="layout">
    <!-- ========= НАСТРОЙКИ ========= -->
    <div class="panel controls">
      <h2>Настройки</h2>

      <div class="control-group">
        <label for="bgUrl">Фоновая картинка таймера (URL)</label>
        <input type="url" id="bgUrl"
               value="https://i.postimg.cc/28yZbpGP/Chat-GPT-Image-19-noab-2025-g-21-37-10.png">
      </div>

      <div class="control-inline">
        <div class="control-group">
          <label for="totalSeconds">Время (сек.)</label>
          <input type="number" id="totalSeconds" min="1" value="30">
        </div>
        <div class="control-group">
          <label for="fontSize">Размер цифр (em)</label>
          <input type="number" id="fontSize" step="0.1" min="1" value="2.8">
        </div>
      </div>

      <div class="control-group">
        <label for="fontName">Шрифт Google Fonts (название)</label>
        <input type="text" id="fontName" value="Emilys Candy">
      </div>

      <div class="control-group">
        <label for="radiusFactor">Радиус круга (% от кадра)</label>
        <input type="range" id="radiusFactor" min="0.15" max="0.6" step="0.01" value="0.35">
      </div>

      <div class="control-inline">
        <div class="control-group">
          <label for="offsetX">Смещение центра (X, px)</label>
          <input type="range" id="offsetX" min="-120" max="120" value="0">
        </div>
        <div class="control-group">
          <label for="offsetY">Смещение центра (Y, px)</label>
          <input type="range" id="offsetY" min="-120" max="120" value="0">
        </div>
      </div>

      <div class="control-inline">
        <div class="control-group">
          <label for="density">Плотность блёсток</label>
          <input type="range" id="density" min="0.4" max="2.0" step="0.1" value="1.0">
        </div>
        <div class="control-group">
          <label for="glowColor">Цвет блёсток</label>
          <input type="color" id="glowColor" value="#7fd7ff">
        </div>
      </div>

      <div class="control-group">
        <label for="digitColor">Цвет цифр</label>
        <input type="color" id="digitColor" value="#e9f8ff">
      </div>

      <div class="control-group checkbox-row">
        <input type="checkbox" id="glowEnabled" checked>
        <label for="glowEnabled">Свечение цифр и блёсток</label>
      </div>

      <button id="generateBtn">Сгенерировать HTML-код</button>
    </div>

    <!-- ========= ПРЕВЬЮ ========= -->
    <div class="preview-wrap">
      <h2>Preview</h2>
      <div class="panel preview-box">
        <div class="timer-preview-root">
          <div class="timer-preview-outer" id="preview-outer">
            <div class="timer-preview-inner">
              <canvas id="preview-canvas"></canvas>
              <div class="timer-preview-time" id="preview-time">0:30</div>
            </div>
          </div>
        </div>
      </div>
      <p class="hint">
        Радиус задаётся от размера фрейма, а не от ширины времени — кольцо не скачет.
      </p>
    </div>

    <!-- ========= ВЫХОДНОЙ КОД ========= -->
    <div class="panel output-wrap">
      <h2>Готовый HTML</h2>
      <textarea id="output" spellcheck="false"></textarea>
      <p class="hint">
        Скопируй код в iframe / расширение Genially. Таймер центрируется и масштабируется вместе с iframe;
        прогресс показывает тонкое кольцо из блёсток вокруг цифр.
      </p>
    </div>
  </div>

  <script>
    // ===== ЭЛЕМЕНТЫ =====
    const bgUrlInput        = document.getElementById('bgUrl');
    const totalSecondsInput = document.getElementById('totalSeconds');
    const fontNameInput     = document.getElementById('fontName');
    const fontSizeInput     = document.getElementById('fontSize');
    const radiusFactorInput = document.getElementById('radiusFactor');
    const offsetXInput      = document.getElementById('offsetX');
    const offsetYInput      = document.getElementById('offsetY');
    const densityInput      = document.getElementById('density');
    const digitColorInput   = document.getElementById('digitColor');
    const glowColorInput    = document.getElementById('glowColor');
    const glowEnabledInput  = document.getElementById('glowEnabled');
    const generateBtn       = document.getElementById('generateBtn');

    const previewOuter   = document.getElementById('preview-outer');
    const previewCanvas  = document.getElementById('preview-canvas');
    const previewTimeEl  = document.getElementById('preview-time');
    const fontLink       = document.getElementById('preview-font-link');
    const outputTextarea = document.getElementById('output');

    const previewCtx = previewCanvas.getContext('2d');

    const previewConfig = {
      totalSeconds: 30,
      fontName: 'Emilys Candy',
      fontSizeEm: 2.8,
      radiusFactor: 0.35, // доля от min(width,height)/2
      offsetX: 0,
      offsetY: 0,
      density: 1.0,
      digitColor: '#e9f8ff',
      glowColor: '#7fd7ff',
      bgUrl: '',
      glowEnabled: true
    };

    function formatTime(sec){
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${m}:${s<10?'0':''}${s}`;
    }

    function updateFontLink(fontName){
      const f = (fontName || 'Emilys Candy').trim().replace(/\s+/g,'+');
      fontLink.href = `https://fonts.googleapis.com/css2?family=${f}&display=swap`;
    }

    function applyPreviewStyles(){
      const bgUrl = bgUrlInput.value.trim();
      previewConfig.bgUrl = bgUrl;
      previewOuter.style.backgroundImage = bgUrl ? `url("${bgUrl}")` : 'none';

      previewConfig.totalSeconds  = parseInt(totalSecondsInput.value,10) || 30;
      previewConfig.fontName      = fontNameInput.value.trim() || 'Emilys Candy';
      previewConfig.fontSizeEm    = parseFloat(fontSizeInput.value) || 2.8;
      previewConfig.radiusFactor  = parseFloat(radiusFactorInput.value) || 0.35;
      previewConfig.offsetX       = parseInt(offsetXInput.value,10) || 0;
      previewConfig.offsetY       = parseInt(offsetYInput.value,10) || 0;
      previewConfig.density       = parseFloat(densityInput.value) || 1.0;
      previewConfig.digitColor    = digitColorInput.value || '#e9f8ff';
      previewConfig.glowColor     = glowColorInput.value || '#7fd7ff';
      previewConfig.glowEnabled   = glowEnabledInput.checked;

      previewTimeEl.style.fontFamily = `'${previewConfig.fontName}', cursive`;
      previewTimeEl.style.fontSize   = previewConfig.fontSizeEm+'em';
      previewTimeEl.style.color      = previewConfig.digitColor;

      const glow = previewConfig.glowEnabled ? previewConfig.glowColor : 'transparent';
      previewTimeEl.style.textShadow = previewConfig.glowEnabled
        ? `0 0 8px ${glow},0 0 16px ${glow}`
        : 'none';

      previewTimeEl.style.left = `calc(50% + ${previewConfig.offsetX}px)`;
      previewTimeEl.style.top  = `calc(50% + ${previewConfig.offsetY}px)`;

      updateFontLink(previewConfig.fontName);
    }

    function resizePreviewCanvas(){
      const rect = previewCanvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      previewCanvas.width  = rect.width * dpr;
      previewCanvas.height = rect.height * dpr;
      previewCtx.setTransform(dpr,0,0,dpr,0,0);
    }

    // центр = центр цифр, радиус = % от min(width,height)
    function getPreviewCircleMetrics(){
      const canvasRect = previewCanvas.getBoundingClientRect();
      const textRect   = previewTimeEl.getBoundingClientRect();

      const cx = (textRect.left + textRect.width/2) - canvasRect.left;
      const cy = (textRect.top  + textRect.height/2) - canvasRect.top;

      const minSize = Math.min(canvasRect.width, canvasRect.height);
      const r = (minSize/2) * previewConfig.radiusFactor;

      return { cx, cy, r };
    }

    function pseudoRand01(i, seed){
      const x = Math.sin(i*12.9898 + seed*78.233)*43758.5453;
      return x - Math.floor(x);
    }

    let previewRemaining = previewConfig.totalSeconds;

    function updatePreviewTime(){
      previewTimeEl.textContent = formatTime(previewRemaining);
    }

    function previewTick(){
      previewRemaining--;
      if (previewRemaining < 0){
        previewRemaining = previewConfig.totalSeconds;
      }
      updatePreviewTime();
    }

    function drawPreviewSparkles(timeMs){
      const ctx = previewCtx;
      ctx.clearRect(0,0,previewCanvas.width,previewCanvas.height);

      const prog = previewRemaining / previewConfig.totalSeconds;
      if (prog <= 0) return;

      const {cx,cy,r} = getPreviewCircleMetrics();

      const DOT_BASE = 80; // немного точек = видно зерно
      const dots = Math.max(12, Math.round(DOT_BASE * previewConfig.density * prog));

      const fullCircle = 2*Math.PI;
      const arcAngle   = fullCircle * prog;
      const startAngle = -Math.PI/2;

      const t = (timeMs || 0)/1000;
      const baseAlpha = 0.45 + 0.35*prog;

      for(let i=0;i<dots;i++){
        const p = dots===1 ? 0 : i/(dots-1);
        const angle = startAngle + p*arcAngle;

        const jitter = (pseudoRand01(i,1)-0.5)*r*0.02;
        const rr = r + jitter;

        const x = cx + Math.cos(angle)*rr;
        const y = cy + Math.sin(angle)*rr;

        const radius = 0.5 + 0.3*Math.sin(t*2.1 + i);
        const alpha  = baseAlpha*(0.7 + 0.3*pseudoRand01(i,3));

        ctx.globalAlpha = Math.max(0.15, Math.min(1, alpha));
        ctx.beginPath();
        ctx.arc(x,y,Math.max(0.3,radius),0,Math.PI*2);
        ctx.fillStyle = previewConfig.glowColor;
        if(previewConfig.glowEnabled){
          ctx.shadowColor = previewConfig.glowColor;
          ctx.shadowBlur  = 3;   // маленький blur, чтобы это были именно точки
        }else{
          ctx.shadowColor = 'transparent';
          ctx.shadowBlur  = 0;
        }
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    function previewLoop(ts){
      drawPreviewSparkles(ts||0);
      requestAnimationFrame(previewLoop);
    }

    // ===== ГЕНЕРАЦИЯ КОДА ДЛЯ GENIALLY =====
    function generateCode(){
      const bgUrl        = bgUrlInput.value.trim();
      const totalSeconds = parseInt(totalSecondsInput.value,10) || 30;
      const fontName     = fontNameInput.value.trim() || 'Emilys Candy';
      const fontParam    = fontName.replace(/\s+/g,'+');
      const fontSizeEm   = parseFloat(fontSizeInput.value) || 2.8;
      const radiusFactor = parseFloat(radiusFactorInput.value) || 0.35;
      const offsetX      = parseInt(offsetXInput.value,10) || 0;
      const offsetY      = parseInt(offsetYInput.value,10) || 0;
      const density      = parseFloat(densityInput.value) || 1.0;
      const digitColor   = digitColorInput.value || '#e9f8ff';
      const glowColor    = glowColorInput.value || '#7fd7ff';
      const glowEnabled  = glowEnabledInput.checked;

      const DOT_BASE = Math.round(80 * density);

      const glowTextShadow = glowEnabled
        ? `text-shadow:0 0 8px ${glowColor},0 0 16px ${glowColor};`
        : `text-shadow:none;`;

      const code = `
<div class="card-iframe">
  <!-- Ice Timer Sparkle -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=${fontParam}&display=swap" rel="stylesheet">

  <style>
    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:transparent;
      overflow:hidden;
    }
    .timer-root{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .timer-outer{
      position:relative;
      width:100%;
      height:100%;
      ${bgUrl ? `background-image:url("${bgUrl}");` : ''}
      background-size:contain;
      background-position:center;
      background-repeat:no-repeat;
      pointer-events:none;
      overflow:hidden;
    }
    .timer-inner{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #sparkle-canvas{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    #time-display{
      position:absolute;
      left:calc(50% + ${offsetX}px);
      top:calc(50% + ${offsetY}px);
      transform:translate(-50%,-50%);
      font-family:'${fontName}',cursive;
      font-size:${fontSizeEm}em;
      color:${digitColor};
      ${glowTextShadow}
      user-select:none;
      z-index:2;
    }
  </style>

  <div class="timer-root">
    <div class="timer-outer">
      <div class="timer-inner">
        <canvas id="sparkle-canvas"></canvas>
        <div id="time-display">0:00</div>
      </div>
    </div>
  </div>

  <script>
    const INITIAL_TOTAL_SECONDS = ${totalSeconds};
    const DOT_BASE = ${DOT_BASE};
    const GLOW_COLOR = "${glowColor}";
    const GLOW_ENABLED = ${glowEnabled ? 'true':'false'};
    const RADIUS_FACTOR = ${radiusFactor};

    let totalSeconds = INITIAL_TOTAL_SECONDS;
    let remainingSeconds = totalSeconds;
    let timerInterval = null;

    const timeDisplay = document.getElementById('time-display');
    const canvas = document.getElementById('sparkle-canvas');
    const ctx = canvas.getContext('2d');

    function formatTime(sec){
      const m = Math.floor(sec/60);
      const s = sec%60;
      return \`\${m}:\${s<10?'0':''}\${s}\`;
    }
    function updateDisplay(){
      timeDisplay.textContent = formatTime(remainingSeconds);
    }

    function pseudoRand01(i, seed){
      const x = Math.sin(i*12.9898 + seed*78.233)*43758.5453;
      return x - Math.floor(x);
    }

    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width*dpr;
      canvas.height = rect.height*dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    function getCircleMetrics(){
      const canvasRect = canvas.getBoundingClientRect();
      const textRect   = timeDisplay.getBoundingClientRect();

      const cx = (textRect.left + textRect.width/2) - canvasRect.left;
      const cy = (textRect.top  + textRect.height/2) - canvasRect.top;

      const minSize = Math.min(canvasRect.width, canvasRect.height);
      const r = (minSize/2) * RADIUS_FACTOR;

      return {cx,cy,r};
    }

    function drawSparkles(timeMs){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const progress = remainingSeconds / totalSeconds;
      if (progress <= 0) return;

      const {cx,cy,r} = getCircleMetrics();
      const fullCircle = 2*Math.PI;
      const arcAngle   = fullCircle * progress;
      const startAngle = -Math.PI/2;

      const dots = Math.max(12, Math.round(DOT_BASE * progress));
      const t = (timeMs||0)/1000;
      const baseAlpha = 0.45 + 0.35*progress;

      for(let i=0;i<dots;i++){
        const p = dots===1 ? 0 : i/(dots-1);
        const angle = startAngle + p*arcAngle;

        const jitter = (pseudoRand01(i,1)-0.5)*r*0.02;
        const rr = r + jitter;

        const x = cx + Math.cos(angle)*rr;
        const y = cy + Math.sin(angle)*rr;

        const radius = 0.5 + 0.3*Math.sin(t*2.1 + i);
        const alpha  = baseAlpha*(0.7 + 0.3*pseudoRand01(i,3));

        ctx.globalAlpha = Math.max(0.15, Math.min(1, alpha));
        ctx.beginPath();
        ctx.arc(x,y,Math.max(0.3,radius),0,Math.PI*2);
        ctx.fillStyle = GLOW_COLOR;
        if(GLOW_ENABLED){
          ctx.shadowColor = GLOW_COLOR;
          ctx.shadowBlur  = 3;
        }else{
          ctx.shadowColor = 'transparent';
          ctx.shadowBlur  = 0;
        }
        ctx.fill();
      }
      ctx.globalAlpha = 1;
    }

    function loop(time){
      drawSparkles(time||0);
      requestAnimationFrame(loop);
    }

    function startTimer(){
      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        if(remainingSeconds<=0){
          clearInterval(timerInterval);
          remainingSeconds=0;
          updateDisplay();
          return;
        }
        remainingSeconds--;
        updateDisplay();
      },1000);
    }

    function init(){
      resizeCanvas();
      updateDisplay();
      startTimer();
      requestAnimationFrame(loop);
    }
    init();
    window.addEventListener('resize',resizeCanvas);
  <\/script>
</div>
`.trim();

      outputTextarea.value = code;
    }

    // ===== СЛУШАТЕЛИ =====
    const inputs = [
      bgUrlInput,totalSecondsInput,fontNameInput,fontSizeInput,
      radiusFactorInput,offsetXInput,offsetYInput,
      densityInput,digitColorInput,glowColorInput,glowEnabledInput
    ];
    inputs.forEach(el => {
      el.addEventListener('input', () => {
        applyPreviewStyles();
        generateCode();
      });
    });
    generateBtn.addEventListener('click', generateCode);

    // ==== ИНИЦИАЛИЗАЦИЯ ПРЕВЬЮ ====
    let previewTimerId = null;
    function startPreviewCountdown(){
      if(previewTimerId) clearInterval(previewTimerId);
      previewRemaining = previewConfig.totalSeconds;
      updatePreviewTime();
      previewTimerId = setInterval(()=>{
        previewTick();
      },1000);
    }

    window.addEventListener('resize', () => {
      resizePreviewCanvas();
    });

    // старт
    applyPreviewStyles();
    resizePreviewCanvas();
    startPreviewCountdown();
    requestAnimationFrame(previewLoop);
    generateCode();
  </script>
</body>
</html>
