<div class="card-iframe">
  <!-- Ice Timer with real sparkles -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Emilys+Candy&display=swap" rel="stylesheet">

  <style>
    html,body{
      margin:0;
      padding:0;
      width:100%;
      height:100%;
      background:transparent;
      overflow:hidden;
    }
    .timer-root{
      width:100%;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .timer-outer{
      position:relative;
      width:100%;
      height:100%;
      background-image:url("https://i.postimg.cc/28yZbpGP/Chat-GPT-Image-19-noab-2025-g-21-37-10.png");
      background-size:contain;
      background-repeat:no-repeat;
      background-position:center;
      pointer-events:none;
      overflow:hidden;
    }
    .timer-inner{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    #sparkle-canvas{
      position:absolute;
      inset:0;
      pointer-events:none;
      /* на всякий случай обрезаем всё внутри круга */
    }
    #time-display{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      font-family:'Emilys Candy',cursive;
      font-size:2.8em;
      color:#ffffff;
      text-shadow:0 0 8px #7fd7ff,0 0 16px #7fd7ff;
      user-select:none;
      z-index:2;
    }
  </style>

  <div class="timer-root">
    <div class="timer-outer">
      <div class="timer-inner">
        <canvas id="sparkle-canvas"></canvas>
        <div id="time-display">0:00</div>
      </div>
    </div>
  </div>

  <script>
    /* НАСТРОЙКИ */
    const INITIAL_TOTAL_SECONDS = 30;          // время таймера
    const GLOW_COLOR = "#7fd7ff";              // цвет блёсток
    const DOT_COUNT  = 160;                    // максимум точек по кругу
    const MIN_DOTS   = 24;                     // минимум, чтобы магия не исчезала резко
    const RADIUS_SCALE = 1.4;                  // радиус = ширина цифр * этот множитель

    let totalSeconds = INITIAL_TOTAL_SECONDS;
    let remainingSeconds = totalSeconds;
    let timerInterval = null;

    const timeDisplay = document.getElementById('time-display');
    const canvas = document.getElementById('sparkle-canvas');
    const ctx = canvas.getContext('2d');

    function formatTime(sec){
      const m = Math.floor(sec/60);
      const s = sec%60;
      return `${m}:${s<10?'0':''}${s}`;
    }
    function updateDisplay(){
      timeDisplay.textContent = formatTime(remainingSeconds);
    }

    function pseudoRand01(i, seed){
      const x = Math.sin(i*12.9898 + seed*78.233)*43758.5453;
      return x - Math.floor(x);
    }

    function resizeCanvas(){
      const rect = canvas.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width*dpr;
      canvas.height = rect.height*dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }

    // центр и радиус круга вокруг ЦИФР
    function getCircleMetrics(){
      const canvasRect = canvas.getBoundingClientRect();
      const textRect   = timeDisplay.getBoundingClientRect();

      const cx = (textRect.left + textRect.width/2) - canvasRect.left;
      const cy = (textRect.top  + textRect.height/2) - canvasRect.top;

      const base = Math.max(textRect.width, textRect.height);
      const r = base * RADIUS_SCALE;

      return {cx,cy,r};
    }

    function drawSparkles(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const progress = remainingSeconds / totalSeconds;
      if (progress <= 0) return;

      const {cx,cy,r} = getCircleMetrics();

      // Клип по кругу, чтобы НИЧЕГО не выходило за пределы дырки
      ctx.save();
      ctx.beginPath();
      ctx.arc(cx, cy, r*1.1, 0, Math.PI*2);
      ctx.clip();

      const fullCircle = 2*Math.PI;
      const arcAngle   = fullCircle * progress;   // сколько круга осталось
      const startAngle = -Math.PI/2;              // сверху

      const dots = Math.max(MIN_DOTS, Math.round(DOT_COUNT * progress));
      const baseAlpha = 0.6 + 0.3*progress;       // чуть тусклее к концу

      for(let i=0;i<dots;i++){
        const t = dots===1 ? 0 : i/(dots-1);      // равномерно по дуге 0..1
        const angle = startAngle + t*arcAngle;

        // совсем небольшой статичный шум по радиусу
        const jitter = (pseudoRand01(i,1)-0.5)*r*0.03;
        const rr = r + jitter;

        const x = cx + Math.cos(angle)*rr;
        const y = cy + Math.sin(angle)*rr;

        const radius = 0.7 + pseudoRand01(i,2)*0.5;  // МЕЛКИЕ точки
        const alpha  = baseAlpha*(0.7 + 0.3*pseudoRand01(i,3));

        ctx.globalAlpha = alpha;
        ctx.beginPath();
        ctx.arc(x,y,radius,0,Math.PI*2);
        ctx.fillStyle = "#e6f7ff";
        ctx.shadowColor = GLOW_COLOR;
        ctx.shadowBlur  = 4;   // маленький блур — чтобы не превращалось в полосу
        ctx.fill();
      }

      ctx.globalAlpha = 1;
      ctx.restore();
    }

    function loop(){
      drawSparkles();
      requestAnimationFrame(loop);
    }

    function startTimer(){
      clearInterval(timerInterval);
      timerInterval = setInterval(()=>{
        if (remainingSeconds <= 0){
          clearInterval(timerInterval);
          remainingSeconds = 0;
          updateDisplay();
          return;
        }
        remainingSeconds--;
        updateDisplay();
      },1000);
    }

    function init(){
      resizeCanvas();
      updateDisplay();
      startTimer();
      loop();
    }

    init();
    window.addEventListener('resize', resizeCanvas);
  </script>
</div>
